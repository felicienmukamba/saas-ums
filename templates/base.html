{% load static %}
{% load core_tags students_tags courses_tags enrollment_tags fees_tags payments_tags expenses_tags grades_tags staff_tags assessments_tags users_tags form_tags %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}UMS{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <style>
        body {
            min-height: 100vh;
            background-color: #f5f7fb;
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: #0d1b2a;
            color: #fff;
            display: flex;
            flex-direction: column;
            transition: transform .3s ease;
        }
        .sidebar-collapsed .sidebar {
            transform: translateX(-260px);
        }
        .sidebar .brand {
            font-weight: 600;
            font-size: 1.3rem;
        }
        .sidebar a {
            color: rgba(255,255,255,.8);
            text-decoration: none;
        }
        .sidebar a.active,
        .sidebar a:hover {
            color: #fff;
        }
        .sidebar-nav a {
            padding: .65rem 1rem;
            border-radius: .35rem;
            display: block;
            font-size: .95rem;
        }
        .sidebar-nav a.active,
        .sidebar-nav a:hover {
            background: rgba(13,110,253,.2);
        }
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        .sidebar-section small {
            text-transform: uppercase;
            opacity: .6;
            letter-spacing: .05em;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .topbar {
            background: #fff;
            border-bottom: 1px solid #e4e9f2;
            padding: 1rem 1.5rem;
        }
        .content {
            flex: 1;
            padding: 2rem;
        }
        @media (max-width: 991.98px) {
            .sidebar {
                position: fixed;
                z-index: 1050;
                height: 100vh;
            }
            .sidebar-collapsed .sidebar {
                transform: translateX(-260px);
            }
            .topbar {
                position: sticky;
                top: 0;
                z-index: 1020;
            }
        }
    </style>
</head>
<body class="sidebar-collapsed">
    <!-- Background avec étoiles -->
    <div class="stars-background">
        <div class="stars"></div>
    </div>
    
    <div class="layout">
        <aside class="sidebar shadow-lg text-white">
            <div class="p-4 border-bottom border-light border-opacity-25">
                <div class="brand d-flex align-items-center justify-content-between">
                    <a href="{% url 'core:dashboard' %}" class="text-white text-decoration-none">UMS</a>
                    <button class="btn btn-sm btn-outline-light d-lg-none" id="sidebarClose">&times;</button>
                </div>
                <div class="mt-3">
                    <p class="mb-0 fw-semibold">{{ request.user.get_full_name|default:request.user.email }}</p>
                    <small class="text-white-50">{{ request.user.get_role_display|default:"Profil" }}</small>
                </div>
            </div>
            <div class="p-4 flex-grow-1 overflow-auto sidebar-nav">
                <div class="sidebar-section">
                    <small class="d-block mb-2">Pilotage</small>
                    <a href="{% url 'core:dashboard' %}" class="{% if request.path == '/' %}active{% endif %}">Tableau de bord</a>
                    <a href="{% url 'core:academic_year_list' %}" class="{% if 'academic-years' in request.path %}active{% endif %}">Années académiques</a>
                    <a href="{% url 'core:faculty_list' %}" class="{% if 'facult' in request.path %}active{% endif %}">Facultés & départements</a>
                    <a href="{% url 'users:user_list' %}" class="{% if 'users' in request.path %}active{% endif %}">Utilisateurs</a>
                </div>
                <div class="sidebar-section">
                    <small class="d-block mb-2">Académique (LMD)</small>
                    <a href="{% url 'students:student_list' %}" class="{% if 'students' in request.path %}active{% endif %}">Étudiants</a>
                    <a href="{% url 'enrollment:enrollment_list' %}" class="{% if 'enrollment' in request.path %}active{% endif %}">Inscriptions</a>
                    <a href="{% url 'courses:course_list' %}" class="{% if 'courses' in request.path %}active{% endif %}">Cours & ouvertures</a>
                    <a href="{% url 'assessments:type_list' %}" class="{% if 'assessments' in request.path %}active{% endif %}">Évaluations</a>
                    <a href="{% url 'grades:grade_list' %}" class="{% if 'grades' in request.path %}active{% endif %}">Notes & proclamations</a>
                    <a href="{% url 'staff:assignment_list' %}" class="{% if 'staff' in request.path %}active{% endif %}">Attributions enseignants</a>
                </div>
                <div class="sidebar-section">
                    <small class="d-block mb-2">Finances</small>
                    <a href="{% url 'fees:academic_fee_list' %}" class="{% if 'fees' in request.path %}active{% endif %}">Frais académiques</a>
                    <a href="{% url 'payments:payment_list' %}" class="{% if 'payments' in request.path %}active{% endif %}">Paiements</a>
                    <a href="{% url 'expenses:expense_list' %}" class="{% if 'expenses' in request.path %}active{% endif %}">Dépenses</a>
                </div>
            </div>
        </aside>
        <div class="main">
            <header class="topbar d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-primary btn-sm d-lg-none" id="sidebarToggle">Menu</button>
                    {% block page_heading %}
                        {% if page_title %}
                            <h1 class="h5 mb-0 text-primary">{{ page_title }}</h1>
                        {% else %}
                            <h1 class="h5 mb-0 text-primary">Université Management System</h1>
                        {% endif %}
                    {% endblock %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    {% if user.is_authenticated %}
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle d-flex align-items-center gap-2" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" alt="Avatar" class="rounded-circle" style="width: 28px; height: 28px; object-fit: cover;">
                                {% else %}
                                    <i class="bi bi-person-circle"></i>
                                {% endif %}
                                <span class="d-none d-md-inline">{{ user.get_full_name|default:user.email|truncatechars:20 }}</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:profile' %}">
                                        <i class="bi bi-person me-2"></i>Mon profil
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:profile_edit' %}">
                                        <i class="bi bi-pencil-square me-2"></i>Modifier le profil
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:change_password' %}">
                                        <i class="bi bi-key me-2"></i>Changer le mot de passe
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'users:logout' %}">
                                        <i class="bi bi-box-arrow-right me-2"></i>Déconnexion
                                    </a>
                                </li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Connexion
                        </a>
                    {% endif %}
                    <div class="text-muted small text-end d-none d-md-block">
                        <div>{% now "d/m/Y" %}</div>
                    </div>
                </div>
            </header>
            <main class="content">
                {% include "partials/messages.html" %}
                {% block hero %}{% endblock %}
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const body = document.body;
            const toggleSidebar = () => body.classList.toggle('sidebar-collapsed');
            const openSidebar = () => body.classList.remove('sidebar-collapsed');

            document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);
            document.getElementById('sidebarClose')?.addEventListener('click', toggleSidebar);

            if (window.innerWidth >= 992) {
                openSidebar();
            }
        })();
    </script>
</body>
</html>

